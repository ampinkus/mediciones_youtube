<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: controllers/youtube.controller.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: controllers/youtube.controller.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * youtube.controller.js
 *
 * Controlador principal del módulo de YouTube.
 * Gestiona:
 * - Alta, modificación, visualización y eliminación de streams.
 * - Consulta de datos desde la API de YouTube.
 * - Generación automática de nombres de streams.
 * - Activación/desactivación de streams.
 * - Conversión de formatos de fecha y hora.
 */

import sequelize from "../database/database.js";
import StreamYouTube from "../models/streams_youtube.js";
import ConfiguracionYouTube from "../models/configuracion_youtube.js";
import MedicionYouTube from "../models/mediciones_youtube.js";
import moment from "moment";
import fetch from "node-fetch";
import { extraerVideoID } from "./utils.controller.js";
import { apiKey } from "../config/youtube.config.js";

/**
 * Convierte una fecha en formato ISO (YYYY-MM-DD o completo) a DD/MM/YYYY.
 * @param {string|null|undefined} fechaISO
 * @returns {string|null}
 */
function formatearFecha(fechaISO) {
  if (!fechaISO) return null;
  const fecha = new Date(fechaISO);
  const dia = String(fecha.getUTCDate()).padStart(2, "0");
  const mes = String(fecha.getUTCMonth() + 1).padStart(2, "0");
  const anio = fecha.getUTCFullYear();
  return `${dia}/${mes}/${anio}`;
}

/**
 * Formatea la hora quitando los segundos (HH:mm).
 * @param {string|null|undefined} horaCompleta
 * @returns {string}
 */
function formatearHora(horaCompleta) {
  if (!horaCompleta) return "";
  const [hh, mm] = horaCompleta.split(":");
  return `${hh}:${mm}`;
}

/**
 * Muestra todos los streams con sus configuraciones asociadas.
 * @route GET /youtube
 */
export const verStreams = async (req, res) => {
  try {
    const streams = await StreamYouTube.findAll({
      include: ConfiguracionYouTube,
      order: [["id", "ASC"]],
    });

    streams.forEach((stream) => {
      const config = stream.ConfiguracionYouTube;
      if (config) {
        config.fecha_formateada = formatearFecha(config.fecha);
        config.fecha_final_formateada = formatearFecha(config.fecha_final);
        config.hora_comienzo_medicion = formatearHora(config.hora_comienzo_medicion);
        config.hora_fin_medicion = formatearHora(config.hora_fin_medicion);
        config.actual_start_time_formateada = formatearHora(config.actual_start_time);
        config.actual_end_time_formateada = formatearHora(config.actual_end_time);
        config.actual_start_time = config.actual_start_time || "";
        config.actual_end_time = config.actual_end_time || "";
      }
    });

    res.render("youtube/youtube", { streams });
  } catch (error) {
    console.error("Error al obtener los streams:", error);
    res.status(500).send("Error al obtener los streams.");
  }
};

/**
 * Muestra el formulario para agregar un nuevo stream.
 * @route GET /youtube/agregar
 */
export const formularioAgregar = (req, res) => {
  const hoy = new Date();
  const dia = String(hoy.getDate()).padStart(2, "0");
  const mes = String(hoy.getMonth() + 1).padStart(2, "0");
  const anio = hoy.getFullYear();
  const fechaHoy = `${dia}/${mes}/${anio}`;

  res.render("youtube/agregarStreamYoutube", {
    fechaHoy,
    horaComienzo: "",
    horaFin: "",
  });
};

/**
 * Guarda un nuevo stream junto con su configuración. Extrae horas desde la API si es posible.
 * @route POST /youtube/guardar
 */
export const guardarStream = async (req, res) => {
  try {
    const {
      nombre_stream,
      url_stream,
      id_canal,
      fecha,
      fecha_final,
      hora_comienzo_medicion,
      hora_fin_medicion,
      intervalo_medicion,
    } = req.body;

    const fechaInicioISO = moment(fecha, "DD/MM/YYYY", true).isValid()
      ? moment(fecha, "DD/MM/YYYY").format("YYYY-MM-DD")
      : null;

    const fechaFinalISO = fecha_final &amp;&amp; moment(fecha_final, "DD/MM/YYYY", true).isValid()
      ? moment(fecha_final, "DD/MM/YYYY").format("YYYY-MM-DD")
      : null;

    if (!fechaInicioISO) {
      console.error("❌ Error: formato de fecha inicial inválido");
      return res.status(400).send("Formato de fecha inicial inválido");
    }

    const nuevoStream = await StreamYouTube.create({
      nombre_stream,
      url_stream,
      id_canal,
    });

    const videoID = extraerVideoID(url_stream);
    let actualStart = null;
    let actualEnd = null;
    let horaInicioMedicion = hora_comienzo_medicion?.trim() || null;
    let horaFinMedicion = hora_fin_medicion?.trim() || null;

    if (videoID) {
      const videoUrl = `https://www.googleapis.com/youtube/v3/videos?part=liveStreamingDetails&amp;id=${videoID}&amp;key=${apiKey}`;
      try {
        const response = await fetch(videoUrl);
        const data = await response.json();
        const lsd = data?.items?.[0]?.liveStreamingDetails;

        actualStart = lsd?.actualStartTime || null;
        actualEnd = lsd?.actualEndTime || null;

        if (actualStart) horaInicioMedicion = actualStart.substring(11, 16);
        if (actualEnd) horaFinMedicion = actualEnd.substring(11, 16);

        if (actualStart?.length > 0) actualStart = actualStart.substring(11, 19);
        if (actualEnd?.length > 0) actualEnd = actualEnd.substring(11, 19);
      } catch (err) {
        console.warn("⚠️ No se pudo obtener actualStartTime/EndTime:", err);
      }
    }

    await ConfiguracionYouTube.create({
      streamId: nuevoStream.id,
      fecha: fechaInicioISO,
      fecha_final: fechaFinalISO,
      hora_comienzo_medicion: horaInicioMedicion,
      hora_fin_medicion: horaFinMedicion,
      intervalo_medicion,
      activo: true,
      actual_start_time: actualStart,
      actual_end_time: actualEnd,
    });

    res.redirect("/youtube");
  } catch (error) {
    console.error("Error al guardar el stream:", error);
    res.status(500).send("Error al guardar el stream");
  }
};

/**
 * Muestra los datos detallados de un stream individual.
 * @route GET /youtube/ver/:id
 */
export const verStream = async (req, res) => {
  const { id } = req.params;

  try {
    const stream = await StreamYouTube.findByPk(id, {
      include: ConfiguracionYouTube,
    });

    if (!stream) return res.status(404).send("Stream no encontrado");

    if (stream.ConfiguracionYouTube) {
      const c = stream.ConfiguracionYouTube;
      c.fecha_formateada = formatearFecha(c.fecha);
      c.fecha_final_formateada = formatearFecha(c.fecha_final);
      c.hora_comienzo_medicion = formatearHora(c.hora_comienzo_medicion);
      c.hora_fin_medicion = formatearHora(c.hora_fin_medicion);
      c.actual_start_time_formateada = formatearHora(c.actual_start_time);
      c.actual_end_time_formateada = formatearHora(c.actual_end_time);
    }

    res.render("youtube/verStreamYoutube", { stream });
  } catch (error) {
    console.error("Error al buscar el stream:", error);
    res.status(500).send("Error interno del servidor");
  }
};

/**
 * Muestra el formulario para editar un stream existente.
 * @route GET /youtube/editar/:id
 */
export const formularioEditar = async (req, res) => {
  try {
    const { id } = req.params;

    const stream = await StreamYouTube.findByPk(id, {
      include: ConfiguracionYouTube,
    });

    if (!stream) return res.status(404).send("Stream no encontrado.");

    if (stream.ConfiguracionYouTube) {
      const c = stream.ConfiguracionYouTube;
      c.fecha_formateada = formatearFecha(c.fecha);
      c.fecha_final_formateada = formatearFecha(c.fecha_final);
      c.hora_comienzo_medicion = formatearHora(c.hora_comienzo_medicion);
      c.hora_fin_medicion = formatearHora(c.hora_fin_medicion);
    }

    res.render("youtube/modificarStreamYoutube", {
      stream,
      errorIdCanal: null,
    });
  } catch (error) {
    console.error("Error al obtener el stream para editar:", error);
    res.status(500).send("Error al obtener el stream.");
  }
};

/**
 * Actualiza los datos de un stream.
 * @route POST /youtube/editar/:id
 */
export const actualizarStream = async (req, res) => {
  try {
    const { id } = req.params;
    const {
      nombre,
      url,
      id_canal,
      fecha_inicial,
      fecha_final,
      hora_comienzo_medicion,
      hora_fin_medicion,
      intervalo_medicion,
    } = req.body;

    await StreamYouTube.update(
      { nombre_stream: nombre, url_stream: url, id_canal },
      { where: { id } }
    );

    const fechaInicialDate = moment(fecha_inicial, "DD/MM/YYYY", true).isValid()
      ? moment(fecha_inicial, "DD/MM/YYYY").toDate()
      : null;

    const fechaFinalDate = fecha_final &amp;&amp; moment(fecha_final, "DD/MM/YYYY", true).isValid()
      ? moment(fecha_final, "DD/MM/YYYY").toDate()
      : null;

    if (!fechaInicialDate) {
      console.error("❌ Fecha inicial inválida");
      return res.status(400).send("Formato de fecha inválido");
    }

    await ConfiguracionYouTube.update(
      {
        fecha: fechaInicialDate,
        fecha_final: fechaFinalDate,
        hora_comienzo_medicion: hora_comienzo_medicion?.trim() || null,
        hora_fin_medicion: hora_fin_medicion?.trim() || null,
        intervalo_medicion: intervalo_medicion ? parseInt(intervalo_medicion) : null,
      },
      { where: { streamId: id } }
    );

    res.redirect("/youtube");
  } catch (error) {
    console.error("Error al actualizar el stream:", error);
    res.status(500).send("Error al actualizar el stream.");
  }
};

/**
 * Elimina un stream y toda su información relacionada.
 * @route POST /youtube/eliminar/:id
 */
export const eliminarStream = async (req, res) => {
  try {
    const { id } = req.params;

    await MedicionYouTube.destroy({ where: { streamId: id } });
    await ConfiguracionYouTube.destroy({ where: { streamId: id } });
    await StreamYouTube.destroy({ where: { id } });

    res.redirect("/youtube");
  } catch (error) {
    console.error("Error al eliminar el stream:", error);
    res.status(500).send("Error al eliminar el stream.");
  }
};

/**
 * Cambia el estado de activo/inactivo de un stream.
 * @route POST /youtube/toggle/:id
 */
export const toggleStream = async (req, res) => {
  const { id } = req.params;

  try {
    const configuracion = await ConfiguracionYouTube.findOne({ where: { streamId: id } });

    if (!configuracion) {
      return res.status(404).send("Configuración no encontrada");
    }

    configuracion.activo = !configuracion.activo;
    await configuracion.save();

    res.redirect("/youtube");
  } catch (error) {
    console.error("Error al alternar el estado del stream:", error);
    res.status(500).send("Error al cambiar el estado del stream.");
  }
};

/**
 * Consulta a la API de YouTube para obtener el título del canal y título del video.
 * @route GET /youtube/api/nombreDesdeUrl
 */
export const obtenerNombreDesdeURL = async (req, res) => {
  try {
    const { url } = req.query;

    if (!url) return res.status(400).json({ error: "Falta la URL" });

    const videoId = extraerVideoID(url);

    if (!videoId || videoId.length !== 11) {
      return res.status(400).json({ error: "URL inválida de YouTube" });
    }

    const apiUrl = `https://www.googleapis.com/youtube/v3/videos?part=snippet&amp;id=${videoId}&amp;key=${apiKey}`;
    const response = await fetch(apiUrl);
    const data = await response.json();

    const video = data.items?.[0];
    if (!video) return res.status(404).json({ error: "Video no encontrado en la API" });

    const channelTitle = video.snippet.channelTitle;
    const title = video.snippet.title;

    const nombre = `${channelTitle} - ${title}`;
    return res.json({ nombre });
  } catch (error) {
    console.error("❌ Error al obtener nombre del video:", error);
    return res.status(500).json({ error: "Error interno del servidor" });
  }
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="controllers_home.controller%250A%250AEste%2520m%25C3%25B3dulo%2520define%2520el%2520controlador%2520de%2520la%2520p%25C3%25A1gina%2520principal%2520del%2520sistema.%250ASe%2520encarga%2520de%2520renderizar%2520la%2520vista%2520de%2520inicio%2520(_home_index_).module_.html">controllers/home.controller

Este módulo define el controlador de la página principal del sistema.
Se encarga de renderizar la vista de inicio ('home/index').</a></li><li><a href="module-app.html">app</a></li><li><a href="module-server.html">server</a></li><li><a href="module-utils.html">utils</a></li><li><a href="module-utils_pathHelper.html">utils/pathHelper</a></li></ul><h3>Global</h3><ul><li><a href="global.html#actualizarStream">actualizarStream</a></li><li><a href="global.html#apiKey">apiKey</a></li><li><a href="global.html#autocompletarIdCanal">autocompletarIdCanal</a></li><li><a href="global.html#canalEstaEnVivo">canalEstaEnVivo</a></li><li><a href="global.html#convertirAHoraArgentina">convertirAHoraArgentina</a></li><li><a href="global.html#dataTable">dataTable</a></li><li><a href="global.html#eliminarStream">eliminarStream</a></li><li><a href="global.html#extractHandle">extractHandle</a></li><li><a href="global.html#extraerVideoID">extraerVideoID</a></li><li><a href="global.html#formatearFecha">formatearFecha</a></li><li><a href="global.html#formatearHora">formatearHora</a></li><li><a href="global.html#formularioAgregar">formularioAgregar</a></li><li><a href="global.html#formularioEditar">formularioEditar</a></li><li><a href="global.html#generarGrafico">generarGrafico</a></li><li><a href="global.html#generarTabla">generarTabla</a></li><li><a href="global.html#guardarStream">guardarStream</a></li><li><a href="global.html#iniciarMediciones">iniciarMediciones</a></li><li><a href="global.html#medirStreamConTimeout">medirStreamConTimeout</a></li><li><a href="global.html#mostrarAlertaManual">mostrarAlertaManual</a></li><li><a href="global.html#mostrarFormulario">mostrarFormulario</a></li><li><a href="global.html#obtenerChannelIdDesdeURL">obtenerChannelIdDesdeURL</a></li><li><a href="global.html#obtenerDatosYouTube">obtenerDatosYouTube</a></li><li><a href="global.html#obtenerIdCanal">obtenerIdCanal</a></li><li><a href="global.html#obtenerIdDesdeHandle">obtenerIdDesdeHandle</a></li><li><a href="global.html#obtenerIdDesdeUsername">obtenerIdDesdeUsername</a></li><li><a href="global.html#obtenerNombreDesdeURL">obtenerNombreDesdeURL</a></li><li><a href="global.html#sequelize">sequelize</a></li><li><a href="global.html#supervisor">supervisor</a></li><li><a href="global.html#syncDatabase">syncDatabase</a></li><li><a href="global.html#toggleStream">toggleStream</a></li><li><a href="global.html#verStream">verStream</a></li><li><a href="global.html#verStreams">verStreams</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Sat Jul 19 2025 13:59:57 GMT-0300 (Argentina Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
